# Docker Upgrade & Permission Issue - Root Cause Analysis

‚ö†Ô∏è **NOTE:** This document describes the original problem that has now been **solved** by integrating ethd update into eth-manager. For current information, see [`ETHD_UPDATE_INTEGRATION.md`](ETHD_UPDATE_INTEGRATION.md).

## The Discovery

**User's Critical Observation:**
> "maybe eth-docker node upgrade is changing owner"

This single observation led to identifying and fixing the root cause of permission issues!

## Root Cause

### What Happens During Upgrade

```
1. docker compose down
   ‚Üì
2. git pull (updates eth-docker repo)
   ‚Üì
3. docker compose pull (gets new images)
   ‚Üì
4. docker compose build (rebuilds images)
   ‚Üì
5. docker compose up -d (starts containers)
   ‚Üì ‚Üê FILES GET CREATED HERE WITH WRONG OWNERSHIP
```

### The Problem

When `docker compose up -d` starts containers:

1. **Container processes run as specific UIDs**
   - Not always as root
   - Often as systemd-coredump or other service UIDs
   - Depends on Dockerfile USER directive

2. **New files created by containers inherit container's UID**
   ```bash
   # Example: prometheus config generated by container
   -rw-rw-r--  1 systemd-coredump systemd-coredump  3404 Oct 19 00:00 base-config.yml
   # Owner: UID 999 (systemd-coredump), not egk (UID 1000)
   ```

3. **ethd commands run as different user (egk)**
   ```bash
   ssh root@minipcamd... "cd /home/egk/eth-docker && ./ethd keys sign-exit 0x..."
   # ethd executes in egk's context
   # But files owned by UID 999
   # Result: "chmod: Operation not permitted"
   ```

4. **Permission mismatch cascade**
   ```
   File owned by UID 999
   ‚Üì
   ethd (UID 1000/egk) can't modify
   ‚Üì
   chmod attempts fail
   ‚Üì
   Exit messages can't be saved
   ‚Üì
   Signing operations fail
   ```

## Why It Wasn't Obvious

### Before Our Fix
```bash
# After upgrade:
ls -la prometheus/base-config.yml
-rw-rw-r--  1 root root 3404 Oct 19 00:00 prometheus/base-config.yml

# Everything LOOKS fine (root:root)
# But new containers might create files as:
-rw-rw-r--  1 systemd-coredump systemd-coredump 3404 ...

# OR after containers run:
-rw-rw-r--  1 nobody nobody 3404 ...

# The ownership depends on:
# - Container image configuration
# - Which processes run during startup
# - When volumes get mounted
# - Order of operations
```

## The Solution

### Level 1: Fix After the Fact
```bash
sudo chown -R egk:egk prometheus/ .eth/
docker compose down && docker compose up -d
```

### Level 2: Automatic Fix On Upgrade (NEW!)
```python
# After docker compose up -d succeeds:
def _fix_docker_permissions_post_upgrade(node_config):
    """Automatically fixes permissions"""
    # 1. Detect target user (egk for minipcamd)
    # 2. chown -R egk:egk prometheus/ .eth/
    # 3. Find and chmod directories to 755
    # 4. Find and chmod files to 644
    # 5. Log results
```

## Architecture: Why egk:egk is Correct

### minipcamd Node Configuration
```yaml
# config.yaml
- name: lido102
  ssh_user: root              # SSH login as root
  eth_docker_path: /home/egk/eth-docker  # But files live in egk's home
```

### User Context
```
SSH as: root
‚îú‚îÄ Can execute: ssh root@minipcamd...
‚îú‚îÄ Can run: sudo chown, sudo chmod
‚îú‚îÄ But working directory is: /home/egk/eth-docker
‚îú‚îÄ So files should be owned by: egk
‚îî‚îÄ Because egk runs ethd commands
```

### Why Not root:root?
```bash
# If files were root:root:
# When ethd (running as egk) tries to create/modify:
# ‚Üí Permission denied (egk can't write root-owned files)
# ‚Üí chmod fails (egk can't chmod root-owned files)
# ‚Üí Operations fail silently

# If files are egk:egk:
# When ethd (running as egk) tries to create/modify:
# ‚Üí Works! (egk can read/write own files)
# ‚Üí chmod works! (egk can chmod own files)
# ‚Üí Operations succeed
```

## Detection Logic

The auto-fix detects:

```python
if ssh_user == 'root' and '/home/egk' in eth_docker_path:
    # Minipcamd node: SSH as root but files in egk's home
    target_user = 'egk'
else:
    # Standard setup: SSH user owns files
    target_user = ssh_user
```

## Files Created During Upgrade

These get permission fixed:

| File/Dir | Before | After | Why |
|----------|--------|-------|-----|
| prometheus/*.yml | root/999 | egk | Config files created by container |
| .eth/exit_messages/* | root/999 | egk | Exit messages need egk to write |
| .eth/validator_keys/* | root/999 | egk | Validator keys need egk to sign |
| .eth/ethdo/* | root/999 | egk | ethdo scripts need egk access |

## Verification

### Before Auto-Fix
```bash
$ ssh root@minipcamd... "cd /home/egk/eth-docker && ./ethd keys sign-exit 0xb3d0e69d..."

chmod: changing permissions of 'prometheus/base-config.yml': Operation not permitted
chmod: changing permissions of '.eth/exit_messages': Operation not permitted
‚ö†Ô∏è  Error 20: Exit message validator key not found
```

### After Auto-Fix
```bash
$ ssh root@minipcamd... "cd /home/egk/eth-docker && ./ethd keys sign-exit 0xb3d0e69d..."

‚úì Signed voluntary exit for validator with public key 0xb3d0e69d...
‚úì Writing the exit message into file succeeded
‚úì Signed exit messages for 1 keys
```

## Timeline of Discovery

1. **User noticed**: "prysm and lodestar still outdated"
2. **Implemented**: Client upgrade function
3. **User encountered**: chmod warnings and exit message failures
4. **Investigation revealed**: minipcamd permission structure
5. **First fix**: Manual `chown -R egk:egk` - worked!
6. **But then**: Same issue after next upgrade
7. **Key insight**: "maybe eth-docker node upgrade is changing owner"
8. **Root cause**: Container restart creates new files with wrong owner
9. **Solution**: Auto-fix permissions after every upgrade
10. **Result**: Idempotent, self-healing upgrades

## Future Implications

### For Your Cluster
- ‚úÖ All future upgrades auto-fix permissions
- ‚úÖ No more manual intervention needed
- ‚úÖ No more chmod warnings on ethd commands
- ‚úÖ Exit message operations work reliably

### For New Nodes
- Design with correct user ownership from start
- Or rely on auto-fix to handle it

### For Documentation
- Explains why user ownership matters
- Shows how to debug permission issues
- Provides reference implementation

## Code References

- **Detection & Fix**: `eth_validators/node_manager.py` ‚Üí `_fix_docker_permissions_post_upgrade()`
- **Integration**: `eth_validators/node_manager.py` ‚Üí `_upgrade_single_network_node()`
- **Usage**: `upgrade_clients.py` ‚Üí uses `upgrade_node_docker_clients()`

## Lesson Learned

üéì **Small observations lead to big insights**

What started as "why are permissions wrong" led to:
- Root cause identification (container file creation)
- Architecture understanding (user context mismatch)
- Permanent solution (auto-fix on upgrade)
- Better reliability (self-healing upgrades)
