#!/bin/bash
# Ethereum Node and Validator Cluster Manager - Wrapper Script
# This script abstracts away Python environment complexity for end users

set -e  # Exit on any error

# Get the directory where this script is located (follow symlinks)
if [[ -L "${BASH_SOURCE[0]}" ]]; then
    # Script is a symlink - resolve it
    REAL_SCRIPT="$(readlink -f "${BASH_SOURCE[0]}")"
    SCRIPT_DIR="$(cd "$(dirname "$REAL_SCRIPT")" && pwd)"
else
    # Script is not a symlink
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi
PROJECT_ROOT="$(cd "$SCRIPT_DIR" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Helper to display configured node names from config.yaml
show_node_list() {
    local config_path="$PROJECT_ROOT/config.yaml"

    if [[ ! -f "$config_path" ]]; then
        print_warning "config.yaml not found. Unable to show node list."
        return
    fi

    local node_output
    if ! node_output=$(python3 - "$config_path" 2>/dev/null <<'PY'
from pathlib import Path
import sys

import yaml

config_path = Path(sys.argv[1])
try:
    data = yaml.safe_load(config_path.read_text()) or {}
except Exception as exc:
    print(f"âš ï¸  Error parsing config.yaml: {exc}")
    sys.exit(1)

nodes = data.get("nodes") or []
if not nodes:
    sys.exit(0)

for node in nodes:
    name = node.get("name") or node.get("tailscale_domain") or "<unknown>"
    print(f"  â€¢ {name}")
PY
    ); then
        print_warning "Could not read node list from config.yaml"
        return
    fi

    if [[ -n "$node_output" ]]; then
        print_info "Configured nodes:"
        echo "$node_output"
        print_info "Pass '--all' to target every node."
    else
        print_warning "No nodes found in config.yaml"
    fi
}

# Function to check if we're in the right directory
check_setup() {
    if [[ ! -f "$PROJECT_ROOT/eth_validators/__main__.py" ]]; then
        print_error "Error: eth_validators module not found in $PROJECT_ROOT"
        print_error "Please run this script from the project root directory or ensure proper installation."
        exit 1
    fi
}

# Function to setup virtual environment if needed
setup_venv() {
    if [[ ! -d "$PROJECT_ROOT/venv" ]]; then
        print_info "Setting up virtual environment..."
        python3 -m venv "$PROJECT_ROOT/venv"
        print_success "Virtual environment created"
    fi

    # Activate virtual environment
    source "$PROJECT_ROOT/venv/bin/activate"
    
    # Export PROJECT_ROOT so Python code can find config.yaml
    export PROJECT_ROOT="$PROJECT_ROOT"
    
    # Add PROJECT_ROOT to PYTHONPATH so eth_validators module can be found
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"

    # Install/update requirements if needed
    if [[ ! -f "$PROJECT_ROOT/.venv_setup_complete" ]] || [[ "$PROJECT_ROOT/requirements.txt" -nt "$PROJECT_ROOT/.venv_setup_complete" ]]; then
        print_info "Installing/updating requirements..."
        pip install --upgrade pip
        if [[ -f "$PROJECT_ROOT/requirements.txt" ]]; then
            pip install -r "$PROJECT_ROOT/requirements.txt"
        fi
        if [[ -f "$PROJECT_ROOT/requirements-ml.txt" ]]; then
            pip install -r "$PROJECT_ROOT/requirements-ml.txt" || print_warning "Some ML requirements failed to install (optional)"
        fi
        touch "$PROJECT_ROOT/.venv_setup_complete"
        print_success "Requirements installed"
    fi
}

# Function to run the actual command
run_command() {
    # Check if we have arguments
    if [[ $# -eq 0 ]]; then
        # No arguments - show help
        python3 -m eth_validators --help
        return
    fi

    if [[ "$1" == "system" && "$2" == "update" ]]; then
        show_node_list
        if [[ $# -lt 3 ]]; then
            print_info "Command options:"
            python3 -m eth_validators system update --help
            print_warning "Specify a node name or use --all, then rerun the command."
            return 0
        fi
    fi

    # Run the actual command
    python3 -m eth_validators "$@"
}

# Main execution
main() {
    print_info "ðŸš€ Ethereum Node and Validator Cluster Manager"

    # Check setup
    check_setup

    # Setup virtual environment
    setup_venv

    # Run the command
    run_command "$@"

    print_success "Command completed"
}

# Handle special case: if script is called with no arguments or --help
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    main "$@"
    exit 0
fi

# Run main function with all arguments
main "$@"
